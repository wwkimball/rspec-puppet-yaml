<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.9
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "README";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'>
<h1 id="label-rspec-puppet-yaml">rspec-puppet-yaml</h1>

<p><a href="https://travis-ci.org/wwkimball/rspec-puppet-yaml"><img
src="https://travis-ci.org/wwkimball/rspec-puppet-yaml.svg?branch=master"></a>
<a href="https://inch-ci.org/github/wwkimball/rspec-puppet-yaml"><img
src="https://inch-ci.org/github/wwkimball/rspec-puppet-yaml.svg?branch=master"></a></p>

<p>This gem enables Puppet module authors to write RSpec unit tests as YAML
instead of Ruby (omitting the single, trivial line of code necessary to
pass your YAML to RSpec). It also adds a new capability: a trivial means to
create test variants (repeat 0-N tests while tweaking any set of inputs and
expectations to detect unintended side-effects). If you&#39;re more
comfortable with YAML than Ruby, or want to easily work with test variants,
then you&#39;ll want this gem.</p>

<p>While this gem spares you from needing to learn Ruby just to test your
Puppet module, you still need to do a little research into what RSpec tests
are available to your YAML. The good news is <a
href="https://github.com/rodjek/rspec-puppet/blob/master/README.md#matchers">that
very knowledge is already documented for the rspec-puppet gem</a> and you
just need to know how to translate it into YAML. While not initially
obvious, it really is very easy.</p>

<p>The source code examples in this document are expanded or direct
translations of each of the matcher samples that are shown in the
rspec-puppet README. Copyright for the original examples is owned by the
maintainers of that gem and are duplicated here in good faith that these
translations into YAML are <em>not</em> competitive and will benefit our
common audience. This rpsec-puppet-yaml gem extends the reach of the
rspec-puppet gem to include users who speak YAML better than Ruby;
rpsec-puppet-yaml does not replace rspec-puppet but rather the written
language that is necessary to interact with it (YAML rather than Ruby).</p>

<p>All following examples will be presented both in the original Ruby and in
the new YAML for comparison. In the most general terms, you can express an
existing RSpec entity in YAML simply by transcribing its name as a Hash key
and its attributes or contents as its children. Just know that I decided to
use <code>tests</code> instead of <code>it</code> to identify the RSpec
examples and I abstracted <code>is_expected.to</code> and
<code>is_expected.not_to</code> rather than exposing them directly to YAML.
This was both an aesthetic decision and to reduce complexity.</p>

<h2 id="label-Installation">Installation</h2>

<p>Add this line to your application&#39;s Gemfile:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rspec-puppet-yaml</span><span class='tstring_end'>&#39;</span></span>
</code></pre>

<p>And then execute:</p>

<pre class="code ruby"><code class="ruby">$ bundle</code></pre>

<p>Or install it yourself as:</p>

<pre class="code ruby"><code class="ruby">$ gem install rspec-puppet-yaml</code></pre>

<h2 id="label-Usage">Usage</h2>

<p>As per the <a
href="https://github.com/rodjek/rspec-puppet/blob/master/README.md#naming-conventions">existing
documentation for rspec-puppet</a>, you will still create RSpec entry-point
files at <code>your_module/spec/**/*_spec.rb</code> (else <code>rake</code>
won&#39;t find your tests, YAML or otherwise). However, these files now
need only two lines of Ruby code (usually) and no RSpec code. You&#39;ll
still require your <code>spec_helper</code> as always, and then just call
the global-scope entry-point function to parse your YAML into RSpec. The
function shown here expects to receive the fully-qualified path and name of
your <code>*_spec.rb</code> file, not your YAML file. The function will
search for your YAML files based on the automatic value of the
<code>__FILE__</code> variable.</p>

<p>For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spec_helper</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_parse_yaml_from_spec'><span class='object_link'><a href="top-level-namespace.html#parse_yaml_from_spec-instance_method" title="#parse_yaml_from_spec (method)">parse_yaml_from_spec</a></span></span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span>
</code></pre>

<p>Yes, that&#39;s it! You can copy-paste those two lines into every
<code>*_spec.rb</code> file and then spend your time writing RSpec Puppet
tests in YAML rather than Ruby. To do so, create another file in the same
directory with the same base name as your <code>*_spec.rb</code> file
except change the extension to <code>.yaml</code> or <code>.yml</code>. In
fact, you don&#39;t even need the <code>_spec</code> part of the name, so
for an RSpec file named <code>my_module_spec.rb</code>, you can use any of
these YAML file-names:</p>
<ul><li>
<p><code>my_module_spec.yaml</code></p>
</li><li>
<p><code>my_module_spec.yml</code></p>
</li><li>
<p><code>my_module.yaml</code></p>
</li><li>
<p><code>my_module.yml</code></p>
</li></ul>

<p>Fair warning: the parser will look for <em>all</em> of these file-names, so
if you create more than one of them, they will all be processed, in turn.</p>

<h3 id="label-Defining+RSpec+Puppet+YAML+Tests">Defining RSpec Puppet YAML Tests</h3>

<p>For the most general-case example, this Ruby:</p>

<pre class="code ruby"><code class="ruby">describe &#39;my_class&#39;, :type =&gt; &#39;class&#39; {
  let(:params) { my_attribute =&gt; &#39;value&#39; }

  it { is_expected.to some_matcher.with_attribute(&#39;value&#39;).and_attribute }

  it { is_expected.not_to another_matcher}
}
</code></pre>

<p>becomes this YAML:</p>

<pre class="code ruby"><code class="ruby">describe:
  name: my_class
  type: class
  let:
    params:
      my_attribute: value
  tests:
    some_matcher:
      with_attribute: value
      and_attribute: nil      # nil indicates a matcher method with no arguments
    &#39;!another_matcher&#39;: {}    # ! negates the matcher and every matcher needs either a Hash or Array value</code></pre>

<p><strong>NOTE</strong>: The top-most entity of every rspec-puppet-yaml file
must be a <code>describe</code>. Each <code>describe</code> must have a
<code>name</code> attribute. The top-most <code>describe</code> must
additionally have a <code>type</code> attribute unless you arrange your
<code>*_spec.rb</code> files according to the recommended rspec-puppet
directory structure (in which case the class can be automatically derived
from its file-system location).</p>

<h4 id="label-Setting+custom+facts-2C+parameters-2C+titles-2C+and+any+other+let+setting">Setting custom facts, parameters, titles, and any other <code>let</code> setting</h4>

<p>Ruby:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_describe'>describe</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>my_module</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_let'>let</span><span class='lparen'>(</span><span class='symbol'>:title</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>baz</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>

  <span class='id identifier rubyid_let'>let</span><span class='lparen'>(</span><span class='symbol'>:params</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>value</span><span class='tstring_end'>&#39;</span></span>   <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>foo</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>user</span><span class='tstring_end'>&#39;</span></span>    <span class='op'>=&gt;</span> <span class='symbol'>:undef</span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>require</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ref'><span class='object_link'><a href="top-level-namespace.html#ref-instance_method" title="#ref (method)">ref</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Package</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sudoku</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>nodes</span><span class='tstring_end'>&#39;</span></span>   <span class='op'>=&gt;</span> <span class='lbrace'>{</span>
        <span class='id identifier rubyid_ref'><span class='object_link'><a href="top-level-namespace.html#ref-instance_method" title="#ref (method)">ref</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Node</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>dbnode</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ref'><span class='object_link'><a href="top-level-namespace.html#ref-instance_method" title="#ref (method)">ref</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Myapp::Mycomponent</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>myapp</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='rbrace'>}</span>
    <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_let'>let</span><span class='lparen'>(</span><span class='symbol'>:node</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>testhost.example.com</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>

  <span class='id identifier rubyid_let'>let</span><span class='lparen'>(</span><span class='symbol'>:environment</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>production</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>

  <span class='id identifier rubyid_let'>let</span><span class='lparen'>(</span><span class='symbol'>:facts</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>os</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span>
        <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>family</span><span class='tstring_end'>&#39;</span></span>  <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RedHat</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
        <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>release</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span>
          <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>major</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>7</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
          <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>minor</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
          <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>full</span><span class='tstring_end'>&#39;</span></span>  <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>7.1.1503</span><span class='tstring_end'>&#39;</span></span>
        <span class='rbrace'>}</span>
      <span class='rbrace'>}</span>
    <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_let'>let</span><span class='lparen'>(</span><span class='symbol'>:node_params</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hostgroup</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>webservers</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rack</span><span class='tstring_end'>&#39;</span></span>      <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>KK04</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>status</span><span class='tstring_end'>&#39;</span></span>    <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>maintenance</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_let'>let</span><span class='lparen'>(</span><span class='symbol'>:pre_condition</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>include other_class</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>

  <span class='id identifier rubyid_let'>let</span><span class='lparen'>(</span><span class='symbol'>:post_condition</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>include another_class</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>

  <span class='id identifier rubyid_let'>let</span><span class='lparen'>(</span><span class='symbol'>:module_path</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/path/to/your/module/dir</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>

  <span class='id identifier rubyid_let'>let</span><span class='lparen'>(</span><span class='symbol'>:trusted_facts</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pp_uuid</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ED803750-E3C7-44F5-BB08-41A04433FE2E</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1.3.6.1.4.1.34380.1.2.1</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ssl-termination</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>YAML:</p>

<pre class="code ruby"><code class="ruby">describe:
  name: my_module
  let:
    title: baz
    node: testhost.example.com
    environment: production
    params:
      value: foo
      user: !ruby/symbol undef  # The symbol-form of `undef` must be used to specify an :undef value
      require: &#39;%{eval:ref(&quot;Package&quot;, &quot;my-package&quot;)}&#39;: # %{eval:...} expands into a command and its arguments which is run via `eval`, capturing its return value.  `&#39;` or `&quot;` demarcation of `%{}` is required only because YAML values are forbidden from starting with a `%`.
      nodes:
        &#39;%{eval:ref(&quot;Node&quot;, &quot;dbnode&quot;)}&#39;: &#39;%{eval:ref(&quot;Myapp::Mycomponent&quot;, &quot;myapp&quot;)}&#39;
    facts:
      os:
        family: RedHat
        release:
          major: 7
          minor: 1
          full: 7.1.1503
    node_params:
      hostgroup: webservers
      rack: KK04
      status: maintenance
    pre_condition: include other_class
    post_condition: include another_class
    module_path: /path/to/your/module/dir
    trusted_facts:
      pp_uuid: ED803750-E3C7-44F5-BB08-41A04433FE2E
      &#39;1.3.6.1.4.1.34380.1.2.1&#39;: ssl-termination</code></pre>

<h4 id="label-The+compile+matcher">The compile matcher</h4>

<p>Ruby:</p>

<pre class="code ruby"><code class="ruby"># Plain test to ensure the module compiles without error
describe &quot;my_module&quot; {
  it { is_expected.to compile }
}

# Expanded test to ensure it compiles with all dependencies
describe &quot;my_module&quot; {
  it { is_expected.to compile.with_all_deps }
}

# Ensure the module *fails* to compile, issuing an expected error message
describe &quot;my_module&quot; {
  it { is_expected.to compile.and_raise_error(/error message match/) }
}
</code></pre>

<p>YAML:</p>

<pre class="code ruby"><code class="ruby"># Plain test to ensure the module compiles without error
describe:
  name: my_module
  tests:
    compile: {}


# Expanded test to ensure it compiles with all dependencies
# Multiple ways to achieve the same net effect!
describe:
  name: my_module
  tests:
    compile: true  # `with_all_deps` is the default test when the `compile` matcher is given any &quot;truthy&quot; value

describe:
  name: my_module
  tests:
    compile:  # Methods that don&#39;t accept arguments can be called from an Array
      - with_all_deps

describe:
  name: my_module
  tests:
    compile:  # Methods that don&#39;t accept arguments can be called from a Hash with nil as their value
      with_all_deps: nil


# Ensure the module *fails* to compile, issuing an expected error message.
# Method 1:  Use a Regular Expression to match part of the error message.  Note
# that in this case, you must identify your value as being a Ruby Regular
# Expression data type with the leading `!ruby/regexp` marker.
describe:
  name: my_module
  tests:
    compile:
      and_raise_error: !ruby/regexp /error message match/

# Method 2:  Match the *entire* error message, not just part of it.  This
# employs a normal String value that requires no additional marker.
describe:
  name: my_module
  tests:
    compile:
      and_raise_error: FULL text of the error message to match</code></pre>

<h4 id="label-The+contain+-28or+create-29+matcher">The contain (or create) matcher</h4>

<p>Ruby:</p>

<pre class="code ruby"><code class="ruby"># Ensure a set of resources exist in the manifest, some with specific attributes
describe &quot;my_module&quot; {
  it { is_expected.to contain_augeas(&#39;bleh&#39;) }

  it { is_expected.to contain_class(&#39;foo&#39;) }

  it { is_expected.to contain_foo__bar(&#39;baz&#39;) }

  it { is_expected.to contain_package(&#39;mysql-server&#39;).with_ensure(&#39;present&#39;) }

  it { is_expected.to contain_package(&#39;httpd&#39;).only_with_ensure(&#39;latest&#39;) }

  it do
    is_expected.to contain_service(&#39;keystone&#39;).with(
      &#39;ensure&#39;     =&gt; &#39;running&#39;,
      &#39;enable&#39;     =&gt; &#39;true&#39;,
      &#39;hasstatus&#39;  =&gt; &#39;true&#39;,
      &#39;hasrestart&#39; =&gt; &#39;true&#39;
    )
  end

  it do
    is_expected.to contain_user(&#39;luke&#39;).only_with(
      &#39;ensure&#39; =&gt; &#39;present&#39;,
      &#39;uid&#39;    =&gt; &#39;501&#39;
    )
  end

  it { is_expected.to contain_file(&#39;/foo/bar&#39;).without_mode }

  it { is_expected.to contain_service(&#39;keystone_2&#39;).without(
    [&#39;restart&#39;, &#39;status&#39;]
  )}

  it { is_expected.to contain_file(&#39;/path/file&#39;).with_content(/foobar/) }

  it do
    is_expected.to contain_file(&#39;/other/path/file&#39;)
      .with_content(/foobar/)
      .with_content(/bazbar/)
  end
}
</code></pre>

<p>YAML:</p>

<pre class="code ruby"><code class="ruby"># Ensure a set of resources exist in the manifest, some with specific attributes
describe:
  name: my_module
  tests:
    contain_augeas:
      bleh: {}
    contain_class:
      foo: {}
    contain_foo__bar:
      baz: {}
    contain_package:
      mysql-server: present  # `with_ensure` is the default test when packages are given any scalar value
      httpd:
        only_with_ensure: latest
    contain_service:
      keystone:
        with:
          ensure: running
          enable: true
          hasstatus: true
          hasrestart: true
      keystone_2:
        without:
          - restart
          - status
    contain_user:
      luke:
        only_with:
          ensure: present
          uid: 501
    contain_file:
      /foo/bar:
        - without_mode
      /path/file:
        with_content: !ruby/regexp /foobar/
      /other/path/file:
        with_content:
          - !ruby/regexp /foobar/
          - !ruby/regexp /bazbar/</code></pre>

<h5 id="label-With+stipulated+resource+relationships">With stipulated resource relationships</h5>

<p>Ruby:</p>

<pre class="code ruby"><code class="ruby">describe &quot;my_module&quot; {
  # Ensure the file, foo, has specific relationships with other resources
  it { is_expected.to contain_file(&#39;foo&#39;).that_requires(&#39;File[bar]&#39;) }

  it { is_expected.to contain_file(&#39;foo&#39;).that_comes_before(&#39;File[baz]&#39;) }

  it { is_expected.to contain_file(&#39;foo&#39;).that_notifies(&#39;File[bim]&#39;) }

  it { is_expected.to contain_file(&#39;foo&#39;).that_subscribes_to(&#39;File[bom]&#39;) }


  # Ensure the file, bar, has specific relationships with many other resources
  it { is_expected.to contain_file(&#39;bar&#39;).that_requires([&#39;File[fim]&#39;, &#39;File[fu]&#39;]) }

  it { is_expected.to contain_file(&#39;bar&#39;).that_comes_before([&#39;File[fam]&#39;,&#39;File[far]&#39;]) }

  it { is_expected.to contain_file(&#39;bar&#39;).that_notifies([&#39;File[fiz]&#39;, &#39;File[faz]&#39;]) }

  it { is_expected.to contain_file(&#39;bar&#39;).that_subscribes_to([&#39;File[fuz]&#39;, &#39;File[fez]&#39;]) }

  # Other relationship example
  it { is_expected.to contain_notify(&#39;bar&#39;).that_comes_before(&#39;Notify[foo]&#39;) }

  it { is_expected.to contain_notify(&#39;foo&#39;).that_requires(&#39;Notify[bar]&#39;) }
}
</code></pre>

<p>YAML:</p>

<pre class="code ruby"><code class="ruby">describe:
  name: my_module
  tests:
    contain_file:
      # Ensure the file, foo, has specific relationships with other resources
      foo:
        that_requires: File[bar]
        that_comes_before: File[baz]
        that_notifies: File[bim]
        that_subscribes_to: File[bom]

      # Ensure the file, bar, has specific relationships with many other resources
      bar:
        that_requires:
          - File[fim]
          - File[fu]
        that_comes_before:
          - File[fam]
          - File[far]
        that_notifies:
          - File[fiz]
          - File[faz]
        that_subscribes_to:
          - File[fuz]
          - File[fez]

    contain_notify:
      bar:
        that_comes_before: Notify[foo]
      foo:
        that_requires: Notify[bar]</code></pre>

<h4 id="label-The+count+matcher">The count matcher</h4>

<p>Ruby:</p>

<pre class="code ruby"><code class="ruby"># Ensure certain resource counts are true
describe &quot;my_module&quot; {
  it { is_expected.to have_resource_count(2) }

  it { is_expected.to have_class_count(2) }

  it { is_expected.to have_exec_resource_count(1) }

  it { is_expected.to have_logrotate__rule_resource_count(3) }
}
</code></pre>

<p>YAML:</p>

<pre class="code ruby"><code class="ruby"># Ensure certain resource counts are true
describe:
  name: my_module
  tests:
    have_resource_count: 2
    have_class_count: 2
    have_exec_resource_count: 1
    have_logrotate__rule_resource_count: 3</code></pre>

<h4 id="label-Type+alias+matchers">Type alias matchers</h4>

<p>Ruby:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_describe'>describe</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>MyModule::Shape</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_it'>it</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_is_expected'>is_expected</span><span class='period'>.</span><span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_allow_value'>allow_value</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>square</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_it'>it</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_is_expected'>is_expected</span><span class='period'>.</span><span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_allow_values'>allow_values</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>circle</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>triangle</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_it'>it</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_is_expected'>is_expected</span><span class='period'>.</span><span class='id identifier rubyid_not_to'>not_to</span> <span class='id identifier rubyid_allow_value'>allow_value</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>blue</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<p>YAML:</p>

<pre class="code ruby"><code class="ruby">describe:
  name: MyModule::Shape
  tests:
    be_valid_type:
      allow_value: square
      allow_values:
          - circle
          - triangle
    &#39;!be_valid_type&#39;:  # The leading ! switches is_expected.to to is_expected.not_to
      allow_value: blue</code></pre>

<h4 id="label-Function+matchers">Function matchers</h4>

<p>Ruby:</p>

<pre class="code ruby"><code class="ruby">describe &#39;my_function&#39; {
  it { is_expected.to run.with_params(&#39;foo&#39;).and_return(&#39;bar&#39;) }
}

describe &#39;my_other_function&#39; {
  it { is_expected.to run.with_params(&#39;foo&#39;, &#39;bar&#39;, [&#39;baz&#39;]) }
}
</code></pre>

<p>YAML:</p>

<pre class="code ruby"><code class="ruby">describe:
  &#39;my_function&#39;:
    tests:
      run:
        with_params: foo
        and_return: bar
      run:
  &#39;my_other_function&#39;:
    tests:
      run:
        with_params:
          - foo
          - bar
          - [&#39;baz&#39;]</code></pre>

<h5 id="label-Negative+tests+and+error+matching">Negative tests and error matching</h5>

<p>Ruby:</p>

<pre class="code ruby"><code class="ruby">describe &#39;my_function&#39; {
  it { is_expected.not_to run.with_params(&#39;a&#39;).and_raise_error(Puppet::ParseError) }
}
</code></pre>

<p>YAML:</p>

<pre class="code ruby"><code class="ruby">describe:
  name: my_function
  tests:
    &#39;!run&#39;:  # Negate a test with a ! prefix, but `&#39;` or `&quot;` demarcate the matcher name becaus a leading ! in YAML denotes a data-type specification.
      with_params: a
      and_raise_error: !ruby/exception Puppet::ParseError
    run:</code></pre>

<h4 id="label-Using+before+and+after">Using <code>before</code> and <code>after</code></h4>

<p>Ruby:</p>

<pre class="code ruby"><code class="ruby">describe &#39;my_function&#39; {
  before(:each) { scope.expects(:lookupvar).with(&#39;some_variable&#39;).returns(&#39;some_value&#39;) }
  it { is_expected.to run.with_params(&#39;...&#39;).and_return(&#39;...&#39;) }
}
</code></pre>

<p>YAML:</p>

<p>YAML indirectly supports executable code in RSpec&#39;s <code>before</code>
and <code>after</code> blocks. It is emulated by first writing a
<em>global</em> scope function in your <code>*_spec.rb</code> file and then
calling that function from the YAML file, as shown in these two snippets:</p>

<p>spec/function/my_function_spec.rb</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spec_helper</span><span class='tstring_end'>&#39;</span></span>

<span class='kw'>def</span> <span class='id identifier rubyid_my_before'>my_before</span>
  <span class='id identifier rubyid_scope'>scope</span><span class='period'>.</span><span class='id identifier rubyid_expects'>expects</span><span class='lparen'>(</span><span class='symbol'>:lookupvar</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_with'>with</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>some_variable</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_returns'>returns</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>some_value</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_parse_yaml_from_spec'><span class='object_link'><a href="top-level-namespace.html#parse_yaml_from_spec-instance_method" title="#parse_yaml_from_spec (method)">parse_yaml_from_spec</a></span></span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span>
</code></pre>

<p>spec/function/my_function_spec.yaml</p>

<pre class="code ruby"><code class="ruby">describe:
  name: my_function
  before: my_before
  tests:
    run:
      with_params: ...
      and_return: ...</code></pre>

<p>Note that <code>before:</code> can specify an Array of global-scope
functions to call, though it may be more intuitive to just define a
global-scope function which calls all of the other functions you need to
chain together. Or not. It depends on your logic.</p>

<p>This technique also helps define custom functions for your tests.</p>

<h4 id="label-Hiera+integration">Hiera integration</h4>

<p>Apart from ensuring that your <code>metadata.json</code> file is valid, you
just don&#39;t need to do anything at all to enable module-level Hiera data
integration; it&#39;s already built into rspec-puppet and it runs quite
well without any additional configuration. If however, you have a valid
use-case for customizing Hiera in order to test out-of-module data – which
should be a really hard sell since you should be testing your Module&#39;s
code, not any out-of-module Hiera data – the above documentation should be
adequate to express such custom Hiera configuration, whether via
<code>let</code> settings or custom functions run during
<code>begin</code>. Should you find the existing support to be inadequate,
feel free to open a qualifying Pull Request that adds whatever additional
support you need.</p>

<h4 id="label-Unsupported+RSpec+Puppet+Features">Unsupported RSpec Puppet Features</h4>

<p>This extension does not support the following features found in
rspec-puppet:</p>
<ol><li>
<p>There is no way to create an example <code>it</code> that uses the
<code>expect()</code> function  instead of <code>is_expected</code>.</p>
</li><li>
<p>With the highest available version of rspec-puppet at the time of this 
writing, there doesn&#39;t seem to be any way to use  <code>subject {
exported_resources }</code> because rspec-puppet throws an error message 
when you try, even when you follow its advice as to where to place the 
<code>subject</code>. You can still add <code>subject</code> to your YAML;
it&#39;s just that  rspec-puppet&#39;s <code>exported_resources</code>
doesn&#39;t seem to be accessible from any  <code>subject</code> today.</p>
</li><li>
<p>In the Function matcher, lambdas are not known to be supported via YAML.
So,  the rspec-puppet example showing <code>run.with_lambda</code> has no
obvious equivalent  in rspec-puppet-yaml. A clever application of the
<code>%{eval:...}</code> expander  might help in some cases, but feel free
to experiment and share back if you  find a way to make this work.</p>
</li></ol>

<h4 id="label-Variants">Variants</h4>

<p>This gem adds a new feature that isn&#39;t present in the gem it extends:
<code>variants</code>. A variant in unit testing is a named repeat of its
parent container with certain inputs and expectations tweaked. For example,
imagine you have 10 base test examples and you want to test the limits of
one input while simultaneously ensuring there are no unintended
side-effects (so, you want to re-run the other 9 tests for each iteration
of changes to the input-under-test). Without variants, you&#39;d have to
duplicate those other 9 test examples over and over. Variants eliminate all
that dupliation in your test definitions, handling the repeating
configuration for you.</p>

<p>Here&#39;s an example of a classic <code>package.pp</code> that enables
customization of the single package&#39;s <code>ensure</code> attribute.
The parent context defines two matcher tests,
<code>have_package_resource_count</code> and <code>contain_package</code>.
Each variant inherits both, then tweaks one aspect or another of the parent
examples. Further, a separate context, <code>package.pp negative
tests</code> does not inherit any tests from the <code>package.pp</code>
context; they are peers rather than dependents.</p>

<pre class="code ruby"><code class="ruby">describe:
  name: my-package
  context:
    &#39;package.pp&#39;:
      tests:
        have_package_resource_count: 1
        contain_package:
          my-package: present
      variants:  # These will all inherit the parent&#39;s tests, tweaking as needed
        &#39;uninstall&#39;:
          let:
            params:
              package_ensure: absent
          tests:
            contain_package:
              my-package: absent
        &#39;pinned package version&#39;:
          let:
            params:
              package_ensure: &#39;1.0.0.el7&#39;
          tests:
            contain_package:
              my-package: &#39;1.0.0.el7&#39;

    &#39;package.pp negative tests&#39;:
      variants:
        &#39;bad package_ensure&#39;:
          let:
            params:
              package_ensure: 2.10
          tests:
            compile:
              and_raise_error: !ruby/regexp /parameter &#39;package_ensure&#39; expects a String value, got Float/</code></pre>

<p>Note that <code>variants</code> inherit everything from their parent
<code>describe</code> or <code>context</code> except the following
attributes:</p>
<ul><li>
<p>variants</p>
</li><li>
<p>before</p>
</li><li>
<p>after</p>
</li><li>
<p>subject</p>
</li></ul>

<h3 id="label-Style+Choices">Style Choices</h3>

<p>Many of the elements can be expressed in multiple ways to achieve the same
effect. For example, containers like <code>describe</code>,
<code>context</code>, and <code>variants</code> can be listed as
more-than-one using either of these forms:</p>

<pre class="code ruby"><code class="ruby"># As implicity named Hash entities
describe:
  name: my_entity
  context:
    &#39;context 1 name&#39;:
      attributes...
    &#39;context 2 name&#39;:
      attributes...

# As explicitly named Hash entities
describe:
  name: my_entity
  context:
    - name: context 1 name
      attributes...
    - name: context 2 name
      attributes...</code></pre>

<p>Keys can also be expressed as symbols, strings, or any combination of them:</p>

<pre class="code ruby"><code class="ruby"># Keys as strings
describe:
  name: my_entity
  context:
    - name: context name
      attribute: value

# Keys as symbols
:describe:
  :name: my_entity
  :context:
    - :name: context name
      :attribute: value</code></pre>

<h2 id="label-Development">Development</h2>

<p>After checking out the repo, run <code>bin/setup</code> to install
dependencies. Then, run <code>bundle install &amp;&amp; bundle exec rake
spec</code> to run the tests. Run <code>yard</code> to generate HTML
documentation files (these generated files are ignored by git, so this is
useful for local preview). You can also run <code>bin/console</code> for an
interactive prompt that will allow you to experiment.</p>

<p>To install this gem onto your local machine, run <code>bundle exec rake
install</code>. To release a new version, update the version number in
<code>version.rb</code>, and then run <code>bundle exec rake
release</code>, which will create a git tag for the version, push git
commits and tags, and push the <code>.gem</code> file to <a
href="https://rubygems.org">rubygems.org</a>.</p>

<p><a href="https://wwkimball.github.io/rspec-puppet-yaml/docs/index.html">API
documentation</a> is available at github.io.</p>

<h2 id="label-Contributing">Contributing</h2>

<p>Bug reports and pull requests are welcome on GitHub at <a
href="https://github.com/wwkimball/rspec-puppet-yaml">github.com/wwkimball/rspec-puppet-yaml</a>.
Contributors are expected to adhere to the <a
href="http://contributor-covenant.org">Contributor Covenant</a>.</p>

<h2 id="label-License">License</h2>

<p>The gem is available as open source under the terms of the <a
href="http://opensource.org/licenses/MIT">MIT License</a>.</p>

<h2 id="label-Code+of+Conduct">Code of Conduct</h2>

<p>Everyone interacting in the rspec-puppet-yaml project’s codebases, issue
trackers, chat rooms and mailing lists is expected to follow the <a
href="https://github.com/wwkimball/rspec-puppet-yaml/blob/master/CODE_OF_CONDUCT.md">code
of conduct</a>.</p>
</div></div>

      <div id="footer">
  Generated on Wed Sep  6 04:17:56 2017 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.9 (ruby-2.4.1).
</div>

    </div>
  </body>
</html>